# (c) @RknDeveloperr
# Rkn Developer 
# Don't Remove Credit ğŸ˜”
# Telegram Channel @RknDeveloper & @Rkn_Botz
# Developer @RknDeveloperr

from pyrogram import Client, filters, errors, types
from config import Rkn_Bots
import asyncio, re, time, sys
from .database import total_user, getid, delete, addCap, updateCap, insert, chnl_ids
from pyrogram.errors import FloodWait
from pyrogram.types import *
from utils import react_msg 

buttons = [[
        InlineKeyboardButton('âœ‡ Uá´˜á´…á´€á´›á´‡s âœ‡', url="https://t.me/HGBOTZ"),
        InlineKeyboardButton('âœ¨ ğ™²ğ™¾ğ™½ğšƒğ™°ğ™²ğšƒ âœ¨', url="https://t.me/Harshit_contact_bot")
    ],[
        InlineKeyboardButton('ã€„ Add to me group ã€„', url="https://t.me/Reaction_99bot?startgroup=botstart")
    ]]

group_buttons = [[InlineKeyboardButton('âœ‡ Uá´˜á´…á´€á´›á´‡s âœ‡', url="https://t.me/HGBOTZ")]] 

@Client.on_message(filters.private & filters.user(Rkn_Bots.ADMIN)  & filters.command(["stats"]))
async def all_db_users_here(client, message):
    start_t = time.time()
    rkn = await message.reply_text("Processing...")
    uptime = time.strftime("%Hh%Mm%Ss", time.gmtime(time.time() - client.uptime))    
    total_users = await total_user()
    end_t = time.time()
    time_taken_s = (end_t - start_t) * 1000
    await rkn.edit(text=f"**--Bot Processed--** \n\n**Bot Started UpTime:** {uptime} \n**Bot Current Ping:** `{time_taken_s:.3f} á´êœ±` \n**All Bot Users:** `{total_users}`")


@Client.on_message(filters.private & filters.user(Rkn_Bots.ADMIN) & filters.command(["broadcast"]))
async def broadcast(bot, message):
    if (message.reply_to_message):
        rkn = await message.reply_text("Bot Processing.\nI am checking all bot users.")
        all_users = await getid()
        tot = await total_user()
        success = 0
        failed = 0
        deactivated = 0
        blocked = 0
        await rkn.edit(f"bot Ê™Ê€á´á´€á´…á´„á´€sá´›ÉªÉ´É¢ started...")
        async for user in all_users:
            try:
                time.sleep(1)
                await message.reply_to_message.copy(user['_id'])
                success += 1
            except errors.InputUserDeactivated:
                deactivated +=1
                await delete({"_id": user['_id']})
            except errors.UserIsBlocked:
                blocked +=1
                await delete({"_id": user['_id']})
            except Exception as e:
                failed += 1
                await delete({"_id": user['_id']})
                pass
            try:
                await rkn.edit(f"<u>Ê™Ê€á´á´€á´…á´„á´€sá´› á´˜Ê€á´á´„á´‡ssÉªÉ´É¢</u>\n\nâ€¢ á´›á´á´›á´€ÊŸ á´œsá´‡Ê€s: {tot}\nâ€¢ sá´œá´„á´„á´‡ssÒ“á´œÊŸ: {success}\nâ€¢ Ê™ÊŸá´á´„á´‹á´‡á´… á´œsá´‡Ê€s: {blocked}\nâ€¢ á´…á´‡ÊŸá´‡á´›á´‡á´… á´€á´„á´„á´á´œÉ´á´›s: {deactivated}\nâ€¢ á´œÉ´sá´œá´„á´„á´‡ssÒ“á´œÊŸ: {failed}")
            except FloodWait as e:
                await asyncio.sleep(t.x)
        await rkn.edit(f"<u>Ê™Ê€á´á´€á´…á´„á´€sá´› á´„á´á´á´˜ÊŸá´‡á´›á´‡á´…</u>\n\nâ€¢ á´›á´á´›á´€ÊŸ á´œsá´‡Ê€s: {tot}\nâ€¢ sá´œá´„á´„á´‡ssÒ“á´œÊŸ: {success}\nâ€¢ Ê™ÊŸá´á´„á´‹á´‡á´… á´œsá´‡Ê€s: {blocked}\nâ€¢ á´…á´‡ÊŸá´‡á´›á´‡á´… á´€á´„á´„á´á´œÉ´á´›s: {deactivated}\nâ€¢ á´œÉ´sá´œá´„á´„á´‡ssÒ“á´œÊŸ: {failed}")
        
# Restart to cancell all process 
@Client.on_message(filters.private & filters.user(Rkn_Bots.ADMIN) & filters.command("restart"))
async def restart_bot(b, m):
    rkn_msg = await b.send_message(text="**ğŸ”„ ğ™¿ğšğ™¾ğ™²ğ™´ğš‚ğš‚ğ™´ğš‚ ğš‚ğšƒğ™¾ğ™¿ğ™´ğ™³. ğ™±ğ™¾ğšƒ ğ™¸ğš‚ ğšğ™´ğš‚ğšƒğ™°ğšğšƒğ™¸ğ™½ğ™¶...**", chat_id=m.chat.id)       
    await asyncio.sleep(3)
    await rkn_msg.edit("**âœ…ï¸ ğ™±ğ™¾ğšƒ ğ™¸ğš‚ ğšğ™´ğš‚ğšƒğ™°ğšğšƒğ™´ğ™³. ğ™½ğ™¾ğš† ğšˆğ™¾ğš„ ğ™²ğ™°ğ™½ ğš„ğš‚ğ™´ ğ™¼ğ™´**")
    os.execl(sys.executable, sys.executable, *sys.argv)
    
@Client.on_message(filters.command("start") & filters.private)
async def start_cmd(bot, message):
    await react_msg(bot, message)
    user_id = int(message.from_user.id)
    reply_markup=InlineKeyboardMarkup(buttons)
    await insert(user_id)
    await message.reply_photo(photo=Rkn_Bots.RKN_PIC,
        caption=f"<b>Há´‡ÊŸÊŸá´ ğŸ˜ {message.from_user.mention} âœ¨</b>\n<b><blockquote>Éª á´€á´ SIMPEL ğŸ˜ BUT á´˜á´á´¡á´‡Ê€êœ°á´œÊŸÊŸ AUTO REACTION Ê™á´á´› á´Šá´œêœ±á´› Make Admin in Your Grouo/Chat to see Magicâ˜œ </blockquote><b>\n\n<b><spoiler>ğŸ”‹Maintained by <a href='https://t.me/Harshit_contact_bot'>â„ğ•’â„ğ•¤â„ğ•šğ•‹</a></spoiler><b>",
        has_spoiler=True, 
        reply_markup=reply_markup)

@Client.on_message(filters.command("start") & filters.group)
async def start_cmd(bot, message):
    await react_msg(bot, message)
    user_id = int(message.from_user.id)
    reply_markup=InlineKeyboardMarkup(group_buttons)
    await insert(user_id)
    await message.reply_text(text=f"<b>Há´‡ÊŸÊŸá´ ğŸ˜ {message.from_user.mention} âœ¨</b>\n<b><blockquote>Éª á´€á´ SIMPEL ğŸ˜ BUT á´˜á´á´¡á´‡Ê€êœ°á´œÊŸÊŸ AUTO REACTION Ê™á´á´› á´Šá´œêœ±á´› Make Admin in Your Grouo/Chat to see Magicâ˜œ </blockquote><b>\n<b><spoiler>ğŸ”‹Maintained by <a href='https://t.me/Harshit_contact_bot'>â„ğ•’â„ğ•¤â„ğ•šğ•‹</a></spoiler><b>",
        reply_markup=reply_markup)

@Client.on_message(filters.all)
async def send_reaction(bot, message):
    await react_msg(bot, message)
